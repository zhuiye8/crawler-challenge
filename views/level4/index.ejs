<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç¬¬4å…³ - VIPé™æ—¶æŠ¢è´­ | çˆ¬è™«æŒ‘æˆ˜èµ›</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Microsoft YaHei', 'PingFang SC', sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      min-height: 100vh;
      color: #fff;
    }
    .header {
      background: linear-gradient(90deg, #f12711 0%, #f5af19 100%);
      padding: 20px;
      text-align: center;
    }
    .header h1 { font-size: 2em; }
    .header .countdown {
      font-size: 1.2em;
      margin-top: 10px;
    }
    .back-btn {
      display: inline-block;
      margin-top: 10px;
      padding: 8px 16px;
      background: rgba(255,255,255,0.2);
      color: #fff;
      text-decoration: none;
      border-radius: 5px;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    /* éªŒè¯ç å¼¹çª— */
    .captcha-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .captcha-modal {
      background: #2a2a4a;
      padding: 30px;
      border-radius: 15px;
      width: 400px;
      max-width: 90%;
    }
    .captcha-title {
      text-align: center;
      margin-bottom: 20px;
      font-size: 1.2em;
    }
    .captcha-image {
      position: relative;
      width: 100%;
      height: 150px;
      background: linear-gradient(45deg, #3498db, #2ecc71);
      border-radius: 10px;
      margin-bottom: 15px;
      overflow: hidden;
    }
    .captcha-puzzle {
      position: absolute;
      width: 50px;
      height: 50px;
      background: rgba(255,255,255,0.9);
      border: 2px solid #fff;
      border-radius: 5px;
      top: 50px;
      left: 10px;
      cursor: grab;
      transition: none;
    }
    .captcha-target {
      position: absolute;
      width: 50px;
      height: 50px;
      background: rgba(0,0,0,0.3);
      border: 2px dashed rgba(255,255,255,0.5);
      border-radius: 5px;
      top: 50px;
    }
    .slider-track {
      width: 100%;
      height: 50px;
      background: #1a1a2e;
      border-radius: 25px;
      position: relative;
      margin-bottom: 15px;
    }
    .slider-thumb {
      width: 50px;
      height: 50px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 50%;
      position: absolute;
      left: 0;
      cursor: grab;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5em;
      user-select: none;
    }
    .slider-thumb:active { cursor: grabbing; }
    .slider-hint {
      text-align: center;
      font-size: 0.9em;
      color: rgba(255,255,255,0.6);
    }
    .captcha-error {
      color: #e74c3c;
      text-align: center;
      margin-top: 10px;
      font-size: 0.9em;
    }
    .captcha-success {
      color: #2ecc71;
      text-align: center;
      margin-top: 10px;
    }
    .hidden { display: none !important; }

    /* å•†å“ç½‘æ ¼ */
    .products-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    .product-card {
      background: rgba(255,255,255,0.05);
      border-radius: 15px;
      padding: 20px;
      border: 1px solid rgba(255,255,255,0.1);
    }
    .product-name {
      font-size: 1.1em;
      font-weight: bold;
      margin-bottom: 10px;
    }
    .price-container {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 15px 0;
    }
    .original-price {
      text-decoration: line-through;
      color: #888;
    }
    .sale-price {
      font-size: 1.5em;
      color: #f5af19;
      font-weight: bold;
    }
    .discount-badge {
      background: #e74c3c;
      padding: 3px 8px;
      border-radius: 5px;
      font-size: 0.85em;
    }
    .stock-info {
      color: #2ecc71;
      font-size: 0.9em;
    }
    .stock-info.low { color: #f39c12; }
    .timer {
      font-size: 0.9em;
      color: #f12711;
      margin-top: 10px;
    }
    .loading {
      text-align: center;
      padding: 50px;
      font-size: 1.2em;
      color: rgba(255,255,255,0.6);
    }
    .bot-warning {
      background: rgba(231,76,60,0.2);
      border: 1px solid #e74c3c;
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 20px;
      text-align: center;
    }
    .debug-info {
      background: rgba(0,0,0,0.3);
      padding: 15px;
      border-radius: 10px;
      margin-top: 20px;
      font-family: monospace;
      font-size: 0.85em;
    }

    .task-description {
      background: rgba(102, 126, 234, 0.1);
      border-bottom: 2px solid rgba(102, 126, 234, 0.3);
      padding: 20px 0;
      margin-bottom: 20px;
    }
    .task-description h2 {
      color: #667eea;
      margin-bottom: 15px;
    }
    .task-description .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 20px;
    }
    .task-content {
      background: rgba(0,0,0,0.2);
      padding: 20px;
      border-radius: 10px;
      line-height: 1.6;
    }
    .task-content strong {
      color: #f5af19;
    }
    .task-content pre {
      background: rgba(0,0,0,0.4);
      padding: 15px;
      border-radius: 5px;
      overflow-x: auto;
      margin: 10px 0;
      font-size: 0.9em;
      color: #e0e0e0;
    }
    .task-content .hint {
      color: #2ecc71;
      font-style: italic;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>ğŸ”¥ VIP é™æ—¶æŠ¢è´­</h1>
    <div class="countdown">é™æ—¶ç‰¹æƒ  - ç‹¬å®¶ä¼˜æƒ ï¼</div>
    <a href="/" class="back-btn">â† è¿”å›é¦–é¡µ</a>
  </div>

  <div class="task-description">
    <div class="container">
      <h2>ğŸ“‹ ä»»åŠ¡è¯´æ˜</h2>
      <div class="task-content">
        <p><strong>ä»»åŠ¡</strong>: é€šè¿‡éªŒè¯åçˆ¬å–VIPé™æ—¶æŠ¢è´­å•†å“æ•°æ®</p>
        <p><strong>æŒ‘æˆ˜</strong>: é€šè¿‡æµè§ˆå™¨æŒ‡çº¹æ£€æµ‹ã€å®Œæˆæ»‘å—éªŒè¯ç ã€è·å–å•†å“æ•°æ®</p>
        <p class="hint">ğŸ’¡ æç¤º: éœ€ä½¿ç”¨Playwright/Puppeteer stealthæ¨¡å¼ï¼Œæ»‘å—éœ€æ¨¡æ‹Ÿäººç±»è½¨è¿¹</p>
        <p><strong>æ•°æ®æ ¼å¼</strong>:</p>
        <pre>[
  {"id": 1, "name": "å•†å“å", "original_price": 1999.99, "sale_price": 1399.99, "discount_percent": 30, "stock": 25},
  ...
]</pre>
      </div>
    </div>
  </div>

  <!-- éªŒè¯ç å¼¹çª— -->
  <div class="captcha-overlay" id="captchaOverlay">
    <div class="captcha-modal">
      <div class="captcha-title">ğŸ”’ è¯·éªŒè¯æ‚¨æ˜¯äººç±»</div>
      <div class="captcha-image" id="captchaImage">
        <div class="captcha-target" id="captchaTarget"></div>
        <div class="captcha-puzzle" id="captchaPuzzle">ğŸ§©</div>
      </div>
      <div class="slider-track" id="sliderTrack">
        <div class="slider-thumb" id="sliderThumb">â†’</div>
      </div>
      <div class="slider-hint">æ‹–åŠ¨æ»‘å—å®Œæˆæ‹¼å›¾éªŒè¯</div>
      <div class="captcha-error hidden" id="captchaError"></div>
      <div class="captcha-success hidden" id="captchaSuccess">âœ“ éªŒè¯æˆåŠŸï¼</div>
    </div>
  </div>

  <div class="container">
    <div class="bot-warning hidden" id="botWarning">
      âš ï¸ æ£€æµ‹åˆ°æœºå™¨äººï¼æ‚¨çš„æµè§ˆå™¨æŒ‡çº¹è¯„åˆ†: <span id="botScore"></span>
    </div>

    <div class="loading" id="loadingMessage">
      æ­£åœ¨éªŒè¯æµè§ˆå™¨... è¯·å®ŒæˆéªŒè¯ç ã€‚
    </div>

    <div class="products-grid hidden" id="productsGrid">
      <!-- å•†å“å°†åœ¨è¿™é‡ŒåŠ è½½ -->
    </div>

    <div class="debug-info hidden" id="debugInfo">
      <strong>è°ƒè¯•ä¿¡æ¯ï¼š</strong><br>
      éªŒè¯ç  ID: <span id="debugCaptchaId"></span><br>
      è®¿é—®ä»¤ç‰Œ: <span id="debugToken"></span><br>
      ç­¾åç®—æ³•: <code>md5(productId + timestamp + SECRET_KEY)</code>
    </div>
  </div>

  <script>
    // ===== æ··æ·†çš„å¯†é’¥ï¼ˆè€ƒç”Ÿéœ€è¦é€†å‘è·å–ï¼‰=====
    const _0x4f23 = ['cr4wl3r', '_ch4ll3ng3', '_2025'];
    const SECRET_KEY = _0x4f23.join('');

    // ===== éªŒè¯ç é€»è¾‘ =====
    const captchaId = '<%= captchaId %>';
    const targetX = <%= captchaTarget %>;
    let accessToken = null;
    let track = [];
    let isDragging = false;
    let startX = 0;
    let currentX = 0;

    // è®¾ç½®ç›®æ ‡ä½ç½®
    document.getElementById('captchaTarget').style.left = targetX + 'px';

    // æ»‘å—æ‹–åŠ¨å¤„ç†
    const sliderThumb = document.getElementById('sliderThumb');
    const sliderTrack = document.getElementById('sliderTrack');
    const captchaPuzzle = document.getElementById('captchaPuzzle');

    function startDrag(e) {
      isDragging = true;
      startX = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX;
      track = [{ x: 0, y: 0, t: Date.now() }];
      sliderThumb.style.cursor = 'grabbing';
    }

    function onDrag(e) {
      if (!isDragging) return;
      e.preventDefault();

      const clientX = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX;
      const clientY = e.type.includes('mouse') ? e.clientY : e.touches[0].clientY;

      let deltaX = clientX - startX;
      const maxX = sliderTrack.offsetWidth - sliderThumb.offsetWidth;
      deltaX = Math.max(0, Math.min(deltaX, maxX));

      currentX = deltaX;
      sliderThumb.style.left = deltaX + 'px';
      captchaPuzzle.style.left = (10 + deltaX) + 'px';

      // è®°å½•è½¨è¿¹ï¼ˆåŒ…å« Y è½´å˜åŒ–ï¼‰
      const rect = sliderTrack.getBoundingClientRect();
      const relativeY = clientY - rect.top - 25;
      track.push({
        x: deltaX,
        y: relativeY,
        t: Date.now()
      });
    }

    function endDrag() {
      if (!isDragging) return;
      isDragging = false;
      sliderThumb.style.cursor = 'grab';

      // éªŒè¯
      verifyCaptcha();
    }

    sliderThumb.addEventListener('mousedown', startDrag);
    sliderThumb.addEventListener('touchstart', startDrag);
    document.addEventListener('mousemove', onDrag);
    document.addEventListener('touchmove', onDrag, { passive: false });
    document.addEventListener('mouseup', endDrag);
    document.addEventListener('touchend', endDrag);

    async function verifyCaptcha() {
      try {
        const response = await fetch('/level4/verify-captcha', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ captchaId, track })
        });

        const result = await response.json();

        if (result.success) {
          accessToken = result.accessToken;
          document.getElementById('captchaSuccess').classList.remove('hidden');
          document.getElementById('captchaError').classList.add('hidden');

          setTimeout(() => {
            document.getElementById('captchaOverlay').classList.add('hidden');
            loadProducts();
          }, 500);
        } else {
          document.getElementById('captchaError').textContent = result.error;
          document.getElementById('captchaError').classList.remove('hidden');

          // é‡ç½®æ»‘å—
          setTimeout(() => {
            sliderThumb.style.left = '0';
            captchaPuzzle.style.left = '10px';
            currentX = 0;
            track = [];
          }, 1000);
        }
      } catch (error) {
        console.error('éªŒè¯å¤±è´¥:', error);
      }
    }

    // ===== æµè§ˆå™¨æŒ‡çº¹æ£€æµ‹ =====
    async function checkFingerprint() {
      const fingerprint = {
        webdriver: navigator.webdriver,
        plugins: navigator.plugins.length,
        languages: navigator.languages?.length || 0,
        chrome: !!window.chrome,
        screenWidth: screen.width,
        screenHeight: screen.height,
        colorDepth: screen.colorDepth,
        timezone: Intl.DateTimeFormat().resolvedOptions().timeZone
      };

      try {
        const response = await fetch('/level4/api/fingerprint', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(fingerprint)
        });

        const result = await response.json();

        if (result.isBot) {
          document.getElementById('botWarning').classList.remove('hidden');
          document.getElementById('botScore').textContent = result.score;
        }

        return result;
      } catch (error) {
        console.error('æŒ‡çº¹æ£€æµ‹å¤±è´¥:', error);
        return { isBot: false };
      }
    }

    // ===== åŠ è½½å•†å“ =====
    async function loadProducts() {
      document.getElementById('loadingMessage').textContent = 'æ­£åœ¨åŠ è½½ç‹¬å®¶ä¼˜æƒ ...';

      try {
        const url = `/level4/api/products?captchaId=${captchaId}&token=${accessToken}`;
        const response = await fetch(url);
        const data = await response.json();

        if (data.error) {
          document.getElementById('loadingMessage').textContent = 'é”™è¯¯: ' + data.error;
          return;
        }

        document.getElementById('loadingMessage').classList.add('hidden');
        document.getElementById('productsGrid').classList.remove('hidden');
        document.getElementById('debugInfo').classList.remove('hidden');

        // æ›´æ–°è°ƒè¯•ä¿¡æ¯
        document.getElementById('debugCaptchaId').textContent = captchaId;
        document.getElementById('debugToken').textContent = accessToken;

        // æ¸²æŸ“å•†å“
        const grid = document.getElementById('productsGrid');
        grid.innerHTML = data.products.map(p => `
          <div class="product-card" data-id="${p.id}" data-secret="${generateSign(p.id)}">
            <div class="product-name">${p.name}</div>
            <div class="price-container">
              <span class="original-price">Â¥${p.original_price.toFixed(2)}</span>
              <span class="sale-price">Â¥${p.sale_price.toFixed(2)}</span>
              <span class="discount-badge">-${p.discount_percent}%</span>
            </div>
            <div class="stock-info ${p.stock < 10 ? 'low' : ''}">
              ğŸ“¦ å‰©ä½™ ${p.stock} ä»¶
            </div>
            <div class="timer">
              â° æˆªæ­¢: ${new Date(p.flash_sale_end).toLocaleTimeString('zh-CN')}
            </div>
          </div>
        `).join('');

      } catch (error) {
        console.error('åŠ è½½å•†å“å¤±è´¥:', error);
        document.getElementById('loadingMessage').textContent = 'åŠ è½½å•†å“å¤±è´¥ã€‚';
      }
    }

    // ===== ç­¾åç”Ÿæˆï¼ˆè€ƒç”Ÿéœ€è¦é€†å‘è¿™ä¸ªå‡½æ•°ï¼‰=====
    function generateSign(productId) {
      const timestamp = Date.now();
      return md5(productId + timestamp + SECRET_KEY);
    }

    // ç®€å•çš„ MD5 å®ç°ï¼ˆç”¨äºç­¾åï¼‰
    function md5(string) {
      function rotateLeft(x, n) { return (x << n) | (x >>> (32 - n)); }
      function addUnsigned(x, y) {
        const x8 = x & 0x80000000, y8 = y & 0x80000000;
        const x4 = x & 0x40000000, y4 = y & 0x40000000;
        const result = (x & 0x3FFFFFFF) + (y & 0x3FFFFFFF);
        if (x4 & y4) return result ^ 0x80000000 ^ x8 ^ y8;
        if (x4 | y4) return (result & 0x40000000) ? result ^ 0xC0000000 ^ x8 ^ y8 : result ^ 0x40000000 ^ x8 ^ y8;
        return result ^ x8 ^ y8;
      }
      function F(x, y, z) { return (x & y) | (~x & z); }
      function G(x, y, z) { return (x & z) | (y & ~z); }
      function H(x, y, z) { return x ^ y ^ z; }
      function I(x, y, z) { return y ^ (x | ~z); }
      function FF(a, b, c, d, x, s, ac) { a = addUnsigned(a, addUnsigned(addUnsigned(F(b, c, d), x), ac)); return addUnsigned(rotateLeft(a, s), b); }
      function GG(a, b, c, d, x, s, ac) { a = addUnsigned(a, addUnsigned(addUnsigned(G(b, c, d), x), ac)); return addUnsigned(rotateLeft(a, s), b); }
      function HH(a, b, c, d, x, s, ac) { a = addUnsigned(a, addUnsigned(addUnsigned(H(b, c, d), x), ac)); return addUnsigned(rotateLeft(a, s), b); }
      function II(a, b, c, d, x, s, ac) { a = addUnsigned(a, addUnsigned(addUnsigned(I(b, c, d), x), ac)); return addUnsigned(rotateLeft(a, s), b); }
      function convertToWordArray(str) {
        let wordCount, messageLength = str.length, temp1 = messageLength + 8;
        let temp2 = (temp1 - (temp1 % 64)) / 64, numberOfWords = (temp2 + 1) * 16;
        let wordArray = Array(numberOfWords - 1), bytePosition = 0, byteCount = 0;
        while (byteCount < messageLength) {
          wordCount = (byteCount - (byteCount % 4)) / 4;
          bytePosition = (byteCount % 4) * 8;
          wordArray[wordCount] = (wordArray[wordCount] || 0) | (str.charCodeAt(byteCount) << bytePosition);
          byteCount++;
        }
        wordCount = (byteCount - (byteCount % 4)) / 4;
        bytePosition = (byteCount % 4) * 8;
        wordArray[wordCount] = wordArray[wordCount] | (0x80 << bytePosition);
        wordArray[numberOfWords - 2] = messageLength << 3;
        wordArray[numberOfWords - 1] = messageLength >>> 29;
        return wordArray;
      }
      function wordToHex(value) {
        let result = '', temp, byte;
        for (byte = 0; byte <= 3; byte++) {
          temp = (value >>> (byte * 8)) & 255;
          result += ('0' + temp.toString(16)).slice(-2);
        }
        return result;
      }
      let x = convertToWordArray(string);
      let a = 0x67452301, b = 0xEFCDAB89, c = 0x98BADCFE, d = 0x10325476;
      const S = [7, 12, 17, 22, 5, 9, 14, 20, 4, 11, 16, 23, 6, 10, 15, 21];
      const K = [0xD76AA478, 0xE8C7B756, 0x242070DB, 0xC1BDCEEE, 0xF57C0FAF, 0x4787C62A, 0xA8304613, 0xFD469501, 0x698098D8, 0x8B44F7AF, 0xFFFF5BB1, 0x895CD7BE, 0x6B901122, 0xFD987193, 0xA679438E, 0x49B40821, 0xF61E2562, 0xC040B340, 0x265E5A51, 0xE9B6C7AA, 0xD62F105D, 0x02441453, 0xD8A1E681, 0xE7D3FBC8, 0x21E1CDE6, 0xC33707D6, 0xF4D50D87, 0x455A14ED, 0xA9E3E905, 0xFCEFA3F8, 0x676F02D9, 0x8D2A4C8A, 0xFFFA3942, 0x8771F681, 0x6D9D6122, 0xFDE5380C, 0xA4BEEA44, 0x4BDECFA9, 0xF6BB4B60, 0xBEBFBC70, 0x289B7EC6, 0xEAA127FA, 0xD4EF3085, 0x04881D05, 0xD9D4D039, 0xE6DB99E5, 0x1FA27CF8, 0xC4AC5665, 0xF4292244, 0x432AFF97, 0xAB9423A7, 0xFC93A039, 0x655B59C3, 0x8F0CCC92, 0xFFEFF47D, 0x85845DD1, 0x6FA87E4F, 0xFE2CE6E0, 0xA3014314, 0x4E0811A1, 0xF7537E82, 0xBD3AF235, 0x2AD7D2BB, 0xEB86D391];
      for (let k = 0; k < x.length; k += 16) {
        let AA = a, BB = b, CC = c, DD = d;
        for (let i = 0; i < 64; i++) {
          let f, g;
          if (i < 16) { f = F(b, c, d); g = i; }
          else if (i < 32) { f = G(b, c, d); g = (5 * i + 1) % 16; }
          else if (i < 48) { f = H(b, c, d); g = (3 * i + 5) % 16; }
          else { f = I(b, c, d); g = (7 * i) % 16; }
          let temp = d;
          d = c; c = b;
          b = addUnsigned(b, rotateLeft(addUnsigned(a, addUnsigned(addUnsigned(f, K[i]), x[k + g] || 0)), S[Math.floor(i / 16) * 4 + (i % 4)]));
          a = temp;
        }
        a = addUnsigned(a, AA); b = addUnsigned(b, BB); c = addUnsigned(c, CC); d = addUnsigned(d, DD);
      }
      return wordToHex(a) + wordToHex(b) + wordToHex(c) + wordToHex(d);
    }

    // åˆå§‹åŒ–
    checkFingerprint();
  </script>
</body>
</html>
